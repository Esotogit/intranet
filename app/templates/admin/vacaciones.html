{% extends "base.html" %}

{% block title %}Gesti√≥n de Vacaciones - Administraci√≥n{% endblock %}

{% block extra_css %}
<style>
    /* Page Header Compacto - Homologado */
    .page-header-card {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        border-radius: 12px;
        padding: 18px 24px;
        color: white;
        margin-bottom: 16px;
        position: relative;
        overflow: hidden;
    }
    .page-header-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    .page-header-card h1 { font-size: 20px; font-weight: 700; margin-bottom: 2px; position: relative; z-index: 1; }
    .page-header-card p { opacity: 0.85; font-size: 13px; position: relative; z-index: 1; }
    
    .filter-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
    }
    
    .tab-btn {
        padding: 8px 18px;
        border: none;
        background: white;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        border: 1px solid var(--border);
    }
    
    .tab-btn:hover {
        background: #e0f2fe;
        color: #0284c7;
        border-color: #7dd3fc;
        transform: translateY(-1px);
    }
    
    .tab-btn.active {
        background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
        color: white;
        border-color: transparent;
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }
    
    .vacaciones-card {
        background: white;
        border-radius: 12px;
        border: 1px solid var(--border);
        overflow: hidden;
    }
    
    .vacaciones-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .vacaciones-table th {
        background: #f8fafc;
        padding: 10px 16px;
        text-align: left;
        font-size: 10px;
        font-weight: 600;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .vacaciones-table td {
        padding: 10px 16px;
        border-top: 1px solid var(--border);
        font-size: 12px;
        color: var(--text-primary);
        vertical-align: middle;
    }
    
    .vacaciones-table tr:hover {
        background: #f8fafc;
    }
    
    .empleado-info {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .empleado-avatar {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        background: linear-gradient(135deg, #0ea5e9, #0284c7);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 11px;
    }
    
    .empleado-nombre {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 12px;
    }
    
    .fecha-rango {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .fecha-rango span {
        font-size: 11px;
    }
    
    .fechas-especificas {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
    }
    
    .fecha-chip {
        display: inline-block;
        padding: 3px 8px;
        background: #f0fdf4;
        color: #166534;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 500;
        border: 1px solid #bbf7d0;
    }
    
    .fecha-chip.more {
        background: #fef3c7;
        color: #92400e;
        border-color: #fcd34d;
        cursor: help;
    }
    
    .dias-badge {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #e0f2fe;
        color: #0284c7;
        padding: 3px 10px;
        border-radius: 20px;
        font-weight: 600;
        font-size: 13px;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }
    
    .status-pendiente {
        background: #fef3c7;
        color: #d97706;
    }
    
    .status-aprobada {
        background: #d1fae5;
        color: #059669;
    }
    
    .status-rechazada {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .actions-cell {
        display: flex;
        gap: 8px;
    }
    
    .btn-aprobar, .btn-rechazar {
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        border: none;
        display: flex;
        align-items: center;
        gap: 6px;
    }
    
    .btn-aprobar {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }
    
    .btn-aprobar:hover {
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        transform: translateY(-1px);
    }
    
    .btn-rechazar {
        background: white;
        color: #ef4444;
        border: 1px solid #fecaca;
    }
    
    .btn-rechazar:hover {
        background: #fef2f2;
        border-color: #f87171;
    }
    
    .empty-state {
        padding: 60px 20px;
        text-align: center;
        color: var(--text-muted);
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
        opacity: 0.5;
    }
    
    /* Filtros adicionales */
    .filters-row {
        display: flex;
        gap: 16px;
        margin-bottom: 16px;
        align-items: center;
        flex-wrap: wrap;
    }
    
    .filter-group {
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .filter-group label {
        font-size: 13px;
        color: var(--text-secondary);
        font-weight: 500;
    }
    
    .filter-group select {
        padding: 8px 12px;
        border: 1px solid var(--border);
        border-radius: 8px;
        font-size: 13px;
        background: white;
        min-width: 120px;
    }
    
    /* Acorde√≥n de fechas */
    .fechas-acordeon {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }
    
    .fechas-principales {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        align-items: center;
    }
    
    .fecha-chip {
        display: inline-block;
        padding: 4px 10px;
        background: #f0fdf4;
        color: #166534;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        border: 1px solid #bbf7d0;
    }
    
    .btn-expandir {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        padding: 4px 10px;
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fcd34d;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-expandir:hover {
        background: #fde68a;
    }
    
    .btn-expandir .arrow {
        transition: transform 0.2s;
    }
    
    .btn-expandir.expanded .arrow {
        transform: rotate(180deg);
    }
    
    .fechas-extra {
        display: none;
        flex-wrap: wrap;
        gap: 4px;
        margin-top: 6px;
        padding-top: 6px;
        border-top: 1px dashed #e5e7eb;
    }
    
    .fechas-extra.show {
        display: flex;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header-card">
    <h1>üèñÔ∏è Gesti√≥n de Vacaciones</h1>
    <p>Aprobar o rechazar solicitudes</p>
</div>

<!-- Filtros -->
<div class="filter-tabs">
    <button class="tab-btn active" onclick="filtrar('pendiente', this)">‚è≥ Pendientes</button>
    <button class="tab-btn" onclick="filtrar('aprobada', this)">‚úÖ Aprobadas</button>
    <button class="tab-btn" onclick="filtrar('rechazada', this)">‚ùå Rechazadas</button>
    <button class="tab-btn" onclick="filtrar('todas', this)">üìã Todas</button>
</div>

<!-- Filtros de fecha -->
<div class="filters-row">
    <div class="filter-group">
        <label>üìÖ Mes:</label>
        <select id="filtroMes" onchange="cargarSolicitudes()">
            <option value="">Todos</option>
            <option value="1">Enero</option>
            <option value="2">Febrero</option>
            <option value="3">Marzo</option>
            <option value="4">Abril</option>
            <option value="5">Mayo</option>
            <option value="6">Junio</option>
            <option value="7">Julio</option>
            <option value="8">Agosto</option>
            <option value="9">Septiembre</option>
            <option value="10">Octubre</option>
            <option value="11">Noviembre</option>
            <option value="12">Diciembre</option>
        </select>
    </div>
    <div class="filter-group">
        <label>üìÜ A√±o:</label>
        <select id="filtroAnio" onchange="cargarSolicitudes()">
            <option value="">Todos</option>
        </select>
    </div>
</div>

<!-- Lista de solicitudes -->
<div class="vacaciones-card">
    <div id="solicitudesLista">
        <p class="empty-state">Cargando solicitudes...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let filtroActual = 'pendiente';
let todasLasSolicitudes = [];

// Inicializar a√±os en el select
function inicializarFiltros() {
    const selectAnio = document.getElementById('filtroAnio');
    const anioActual = new Date().getFullYear();
    
    for (let i = anioActual; i >= anioActual - 3; i--) {
        const option = document.createElement('option');
        option.value = i;
        option.textContent = i;
        selectAnio.appendChild(option);
    }
}

async function cargarSolicitudes() {
    const container = document.getElementById('solicitudesLista');
    container.innerHTML = '<p class="empty-state">Cargando...</p>';
    
    try {
        let url = '/api/vacaciones/todas';
        if (filtroActual !== 'todas') {
            url += `?estatus=${filtroActual}`;
        }
        
        const response = await fetch(url);
        if (response.ok) {
            todasLasSolicitudes = await response.json();
            
            // Aplicar filtros de fecha
            let solicitudesFiltradas = filtrarPorFecha(todasLasSolicitudes);
            
            if (solicitudesFiltradas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üèñÔ∏è</div>
                        <p>No hay solicitudes ${filtroActual !== 'todas' ? filtroActual + 's' : ''}</p>
                    </div>
                `;
                return;
            }
            
            let html = `
                <table class="vacaciones-table">
                    <thead>
                        <tr>
                            <th>Empleado</th>
                            <th>Fechas</th>
                            <th>D√≠as</th>
                            <th>Motivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            solicitudesFiltradas.forEach((sol, index) => {
                const nombre = sol.empleado ? sol.empleado.nombre : '';
                const apellidos = sol.empleado ? sol.empleado.apellidos : '';
                const initials = (nombre[0] || '') + (apellidos[0] || '');
                
                const statusIcons = { 'pendiente': '‚è≥', 'aprobada': '‚úÖ', 'rechazada': '‚ùå' };
                
                // Formatear fechas con acorde√≥n
                let fechasHtml = '';
                if (sol.dias_especificos && sol.dias_especificos.length > 0) {
                    const diasOrdenados = [...sol.dias_especificos].sort();
                    
                    if (diasOrdenados.length <= 2) {
                        // Pocos d√≠as - mostrar todos
                        fechasHtml = `<div class="fechas-acordeon">
                            <div class="fechas-principales">
                                ${diasOrdenados.map(d => `<span class="fecha-chip">üìÖ ${d}</span>`).join('')}
                            </div>
                        </div>`;
                    } else {
                        // Muchos d√≠as - acorde√≥n
                        const primerasFechas = diasOrdenados.slice(0, 2);
                        const restantes = diasOrdenados.slice(2);
                        
                        fechasHtml = `<div class="fechas-acordeon">
                            <div class="fechas-principales">
                                ${primerasFechas.map(d => `<span class="fecha-chip">üìÖ ${d}</span>`).join('')}
                                <button class="btn-expandir" onclick="toggleFechas(this, ${index})">
                                    +${restantes.length} m√°s <span class="arrow">‚ñº</span>
                                </button>
                            </div>
                            <div class="fechas-extra" id="fechas-extra-${index}">
                                ${restantes.map(d => `<span class="fecha-chip">üìÖ ${d}</span>`).join('')}
                            </div>
                        </div>`;
                    }
                } else {
                    // Rango continuo
                    fechasHtml = `<div class="fecha-rango">
                        <span>üìÖ ${sol.fecha_inicio}</span>
                        <span>‚ûú ${sol.fecha_fin}</span>
                    </div>`;
                }
                
                html += `
                    <tr>
                        <td>
                            <div class="empleado-info">
                                <div class="empleado-avatar">${initials}</div>
                                <span class="empleado-nombre">${nombre} ${apellidos}</span>
                            </div>
                        </td>
                        <td>${fechasHtml}</td>
                        <td><span class="dias-badge">${sol.dias_solicitados} d√≠as</span></td>
                        <td>${sol.motivo || '-'}</td>
                        <td><span class="status-badge status-${sol.estatus}">${statusIcons[sol.estatus]} ${sol.estatus}</span></td>
                        <td>
                            ${sol.estatus === 'pendiente' ? `
                                <div class="actions-cell">
                                    <button class="btn-aprobar" onclick="aprobar('${sol.id}')">‚úì Aprobar</button>
                                    <button class="btn-rechazar" onclick="rechazar('${sol.id}')">‚úó Rechazar</button>
                                </div>
                            ` : '<span style="color:var(--text-muted)">-</span>'}
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
    } catch (error) {
        container.innerHTML = '<p class="empty-state">Error al cargar las solicitudes</p>';
    }
}

function filtrar(estatus, btn) {
    filtroActual = estatus;
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    cargarSolicitudes();
}

async function aprobar(id) {
    if (!confirm('¬øAprobar esta solicitud de vacaciones?')) return;
    
    const response = await fetch(`/api/vacaciones/${id}/aprobar`, { method: 'PATCH' });
    if (response.ok) {
        cargarSolicitudes();
    } else {
        alert('Error al aprobar');
    }
}

async function rechazar(id) {
    const comentario = prompt('Motivo del rechazo:');
    if (!comentario) return;
    
    const response = await fetch(`/api/vacaciones/${id}/rechazar?comentario=${encodeURIComponent(comentario)}`, { method: 'PATCH' });
    if (response.ok) {
        cargarSolicitudes();
    } else {
        alert('Error al rechazar');
    }
}

// Filtrar solicitudes por mes y a√±o
function filtrarPorFecha(solicitudes) {
    const mes = document.getElementById('filtroMes').value;
    const anio = document.getElementById('filtroAnio').value;
    
    if (!mes && !anio) return solicitudes;
    
    return solicitudes.filter(sol => {
        // Verificar por d√≠as espec√≠ficos o por fecha_inicio
        let fechasAVerificar = [];
        
        if (sol.dias_especificos && sol.dias_especificos.length > 0) {
            fechasAVerificar = sol.dias_especificos;
        } else if (sol.fecha_inicio) {
            fechasAVerificar = [sol.fecha_inicio];
        }
        
        return fechasAVerificar.some(fecha => {
            const [y, m] = fecha.split('-');
            const coincideMes = !mes || parseInt(m) === parseInt(mes);
            const coincideAnio = !anio || parseInt(y) === parseInt(anio);
            return coincideMes && coincideAnio;
        });
    });
}

// Toggle acorde√≥n de fechas
function toggleFechas(btn, index) {
    const extraDiv = document.getElementById(`fechas-extra-${index}`);
    if (extraDiv) {
        extraDiv.classList.toggle('show');
        btn.classList.toggle('expanded');
        
        // Cambiar texto del bot√≥n
        const numExtra = extraDiv.querySelectorAll('.fecha-chip').length;
        if (extraDiv.classList.contains('show')) {
            btn.innerHTML = `Ocultar <span class="arrow">‚ñ≤</span>`;
        } else {
            btn.innerHTML = `+${numExtra} m√°s <span class="arrow">‚ñº</span>`;
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    inicializarFiltros();
    cargarSolicitudes();
});
</script>
{% endblock %}
