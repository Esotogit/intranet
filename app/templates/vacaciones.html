{% extends "base.html" %}

{% block title %}Solicitud de Vacaciones - Intranet{% endblock %}

{% block extra_css %}
<style>
    /* Page Header */
    .page-header-card {
        background: linear-gradient(135deg, #3d5a73 0%, #0093b0 100%);
        border-radius: 16px;
        padding: 28px 32px;
        color: white;
        margin-bottom: 24px;
        position: relative;
        overflow: hidden;
    }
    
    .page-header-card::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 50%;
    }
    
    .page-header-card h1 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 4px;
        position: relative;
        z-index: 1;
    }
    
    .page-header-card p {
        opacity: 0.9;
        font-size: 14px;
        position: relative;
        z-index: 1;
    }
    
    /* Stats Cards */
    .vacation-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 20px;
        margin-bottom: 28px;
    }
    
    .vacation-stat-card {
        background: white;
        border-radius: 14px;
        padding: 24px;
        border: 1px solid var(--border);
        text-align: center;
        position: relative;
        overflow: hidden;
    }
    
    .vacation-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .vacation-stat-card.available::before { background: linear-gradient(90deg, #0093b0, #7badc4); }
    .vacation-stat-card.pending::before { background: linear-gradient(90deg, #3d5a73, #7badc4); }
    .vacation-stat-card.used::before { background: linear-gradient(90deg, #1e3a5f, #3d5a73); }
    
    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        margin: 0 auto 16px;
    }
    
    .vacation-stat-card.available .stat-icon { background: rgba(0, 147, 176, 0.1); }
    .vacation-stat-card.pending .stat-icon { background: rgba(61, 90, 115, 0.1); }
    .vacation-stat-card.used .stat-icon { background: rgba(30, 58, 95, 0.1); }
    
    .stat-value {
        font-size: 36px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
    }
    
    .vacation-stat-card.available .stat-value { color: #0093b0; }
    .vacation-stat-card.pending .stat-value { color: #3d5a73; }
    .vacation-stat-card.used .stat-value { color: #1e3a5f; }
    
    .stat-label {
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 8px;
    }
    
    /* Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 1.2fr 0.8fr;
        gap: 24px;
    }
    
    /* Form Card */
    .form-card {
        background: white;
        border-radius: 14px;
        border: 1px solid var(--border);
        overflow: hidden;
    }
    
    .form-card-header {
        padding: 16px 24px;
        background: linear-gradient(135deg, #1e3a5f, #3d5a73);
    }
    
    .form-card-title {
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
        color: white;
    }
    
    .form-card-body {
        padding: 24px;
    }
    
    /* Calendar Styles */
    .calendar-container {
        margin-bottom: 16px;
        max-width: 320px;
    }
    
    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .calendar-nav-btn {
        background: #f1f5f9;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    
    .calendar-nav-btn:hover {
        background: #e2e8f0;
    }
    
    .calendar-month-year {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 3px;
    }
    
    .calendar-day-header {
        text-align: center;
        font-size: 10px;
        font-weight: 600;
        color: var(--text-secondary);
        padding: 4px 0;
        text-transform: uppercase;
    }
    
    .calendar-day {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.15s;
        position: relative;
        border: 2px solid transparent;
    }
    
    .calendar-day:hover:not(.disabled):not(.weekend) {
        background: #e0f2fe;
    }
    
    .calendar-day.empty {
        cursor: default;
    }
    
    .calendar-day.today {
        font-weight: 700;
        color: #0093b0;
    }
    
    .calendar-day.weekend {
        color: #94a3b8;
        background: #f8fafc;
        cursor: not-allowed;
    }
    
    .calendar-day.disabled {
        color: #cbd5e1;
        cursor: not-allowed;
    }
    
    .calendar-day.selected {
        background: linear-gradient(135deg, #0093b0, #007a94);
        color: white;
        font-weight: 600;
    }
    
    .calendar-day.selected:hover {
        background: linear-gradient(135deg, #007a94, #006680);
    }
    
    /* Selected Days List */
    .selected-days-container {
        margin-bottom: 20px;
    }
    
    .selected-days-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
    }
    
    .selected-days-title {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .clear-all-btn {
        font-size: 12px;
        color: #ef4444;
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px 8px;
        border-radius: 4px;
    }
    
    .clear-all-btn:hover {
        background: #fef2f2;
    }
    
    .selected-days-list {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        max-height: 120px;
        overflow-y: auto;
        padding: 4px;
    }
    
    .selected-day-chip {
        display: flex;
        align-items: center;
        gap: 6px;
        background: linear-gradient(135deg, #e0f2fe, #bae6fd);
        color: #0369a1;
        padding: 6px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 500;
    }
    
    .selected-day-chip .remove-day {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: rgba(0, 0, 0, 0.1);
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        color: #0369a1;
    }
    
    .selected-day-chip .remove-day:hover {
        background: rgba(0, 0, 0, 0.2);
    }
    
    .no-days-selected {
        color: var(--text-secondary);
        font-size: 13px;
        text-align: center;
        padding: 16px;
        background: #f8fafc;
        border-radius: 8px;
    }
    
    /* Days Calculator */
    .days-calculator {
        background: linear-gradient(135deg, #0093b0 0%, #007a94 100%);
        border-radius: 10px;
        padding: 16px;
        text-align: center;
        color: white;
        margin-bottom: 16px;
    }
    
    .days-calculator-value {
        font-size: 36px;
        font-weight: 700;
        line-height: 1;
    }
    
    .days-calculator-label {
        font-size: 12px;
        opacity: 0.9;
        margin-top: 4px;
    }
    
    /* Form Styles */
    .form-group {
        margin-bottom: 16px;
    }
    
    .form-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        display: block;
    }
    
    .form-textarea {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 14px;
        transition: all 0.2s;
        min-height: 80px;
        resize: vertical;
    }
    
    .form-textarea:focus {
        outline: none;
        border-color: #0093b0;
        box-shadow: 0 0 0 3px rgba(0, 147, 176, 0.1);
    }
    
    .btn-submit {
        width: 100%;
        padding: 14px;
        background: linear-gradient(135deg, #0093b0, #007a94);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    
    .btn-submit:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 147, 176, 0.3);
    }
    
    .btn-submit:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* History Card */
    .history-card {
        background: white;
        border-radius: 14px;
        border: 1px solid var(--border);
        overflow: hidden;
    }
    
    .history-card-header {
        padding: 16px 24px;
        background: linear-gradient(135deg, #3d5a73, #1e3a5f);
    }
    
    .history-card-body {
        padding: 0;
        max-height: 600px;
        overflow-y: auto;
    }
    
    /* Tabs */
    .tabs {
        display: flex;
        gap: 4px;
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
        background: white;
    }
    
    .tab-btn {
        padding: 8px 16px;
        border: none;
        background: #f1f5f9;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        color: var(--text-secondary);
    }
    
    .tab-btn.active {
        background: #0093b0;
        color: white;
    }
    
    /* Request Items */
    .request-item {
        padding: 16px 24px;
        border-bottom: 1px solid var(--border);
    }
    
    .request-item:last-child {
        border-bottom: none;
    }
    
    .request-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }
    
    .request-dates {
        font-weight: 600;
        color: var(--text-primary);
        font-size: 14px;
    }
    
    .request-badge {
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 11px;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .request-badge.pending {
        background: #fef3c7;
        color: #92400e;
    }
    
    .request-badge.approved {
        background: #d1fae5;
        color: #065f46;
    }
    
    .request-badge.rejected {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .request-details {
        display: flex;
        gap: 16px;
        font-size: 13px;
        color: var(--text-secondary);
    }
    
    .request-days-list {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 8px;
        line-height: 1.5;
    }
    
    .request-actions {
        margin-top: 12px;
    }
    
    .btn-cancel-request {
        padding: 6px 12px;
        border: 1px solid #ef4444;
        background: white;
        color: #ef4444;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .btn-cancel-request:hover {
        background: #fef2f2;
    }
    
    /* Empty State */
    .empty-state {
        padding: 40px;
        text-align: center;
        color: var(--text-secondary);
    }
    
    .empty-state-icon {
        font-size: 48px;
        margin-bottom: 16px;
    }
    
    /* Status Toast */
    .status-toast {
        position: fixed;
        bottom: 24px;
        right: 24px;
        padding: 14px 24px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 500;
        font-size: 14px;
        z-index: 9999;
        transform: translateY(100px);
        opacity: 0;
        transition: all 0.3s ease;
    }
    
    .status-toast.show {
        transform: translateY(0);
        opacity: 1;
    }
    
    .status-toast.success {
        background: #10b981;
        color: white;
    }
    
    .status-toast.error {
        background: #ef4444;
        color: white;
    }
    
    /* Responsive */
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .vacation-stats {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (max-width: 640px) {
        .vacation-stats {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header-card">
    <h1>üèñÔ∏è Solicitud de Vacaciones</h1>
    <p>Selecciona los d√≠as que deseas solicitar</p>
</div>

<!-- Stats -->
<div class="vacation-stats">
    <div class="vacation-stat-card available">
        <div class="stat-icon">üìÖ</div>
        <div class="stat-value" id="diasDisponibles">0</div>
        <div class="stat-label">D√≠as disponibles</div>
    </div>
    <div class="vacation-stat-card pending">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-value" id="diasPendientes">0</div>
        <div class="stat-label">D√≠as pendientes</div>
    </div>
    <div class="vacation-stat-card used">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-value" id="diasUsados">0</div>
        <div class="stat-label">D√≠as utilizados</div>
    </div>
</div>

<div class="content-grid">
    <!-- Nueva Solicitud -->
    <div class="form-card">
        <div class="form-card-header">
            <h3 class="form-card-title">
                <span>üìù</span> Nueva Solicitud
            </h3>
        </div>
        <div class="form-card-body">
            <form id="vacacionesForm">
                <!-- Calendario -->
                <div class="calendar-container">
                    <div class="calendar-nav">
                        <button type="button" class="calendar-nav-btn" onclick="cambiarMes(-1)">‚Äπ</button>
                        <span class="calendar-month-year" id="calendarMonthYear">Enero 2026</span>
                        <button type="button" class="calendar-nav-btn" onclick="cambiarMes(1)">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Se genera din√°micamente -->
                    </div>
                </div>
                
                <!-- D√≠as seleccionados -->
                <div class="selected-days-container">
                    <div class="selected-days-header">
                        <span class="selected-days-title">D√≠as seleccionados</span>
                        <button type="button" class="clear-all-btn" onclick="limpiarSeleccion()" id="clearAllBtn" style="display: none;">
                            ‚úï Limpiar todo
                        </button>
                    </div>
                    <div class="selected-days-list" id="selectedDaysList">
                        <div class="no-days-selected">Haz clic en los d√≠as del calendario para seleccionarlos</div>
                    </div>
                </div>
                
                <div class="days-calculator">
                    <div class="days-calculator-value" id="diasSolicitados">0</div>
                    <div class="days-calculator-label">d√≠as h√°biles solicitados</div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Tipo de solicitud</label>
                    <select id="tipoSolicitud" class="form-select" style="width: 100%; padding: 10px 14px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px;">
                        <option value="usar_dias">Usar d√≠as de vacaciones</option>
                        <option value="prima_vacacional">Pago de prima vacacional</option>
                        <option value="paternidad">D√≠as por paternidad</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Motivo (opcional)</label>
                    <textarea id="motivo" class="form-textarea" placeholder="Describe el motivo de tu solicitud..."></textarea>
                </div>
                
                <button type="submit" class="btn-submit" id="submitBtn" disabled>
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                    Enviar Solicitud
                </button>
            </form>
        </div>
    </div>
    
    <!-- Historial -->
    <div class="history-card">
        <div class="history-card-header">
            <h3 class="form-card-title">
                <span>üìã</span> Mis Solicitudes
            </h3>
        </div>
        
        <div class="tabs">
            <button class="tab-btn active" onclick="filtrarSolicitudes('todas')">Todas</button>
            <button class="tab-btn" onclick="filtrarSolicitudes('pendiente')">Pendientes</button>
            <button class="tab-btn" onclick="filtrarSolicitudes('aprobada')">Aprobadas</button>
            <button class="tab-btn" onclick="filtrarSolicitudes('rechazada')">Rechazadas</button>
        </div>
        
        <div class="history-card-body" id="solicitudesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">üì≠</div>
                <p>No hay solicitudes para mostrar</p>
            </div>
        </div>
    </div>
</div>

<!-- Toast -->
<div class="status-toast" id="statusToast">
    <span id="statusIcon">‚úì</span>
    <span id="statusText">Mensaje</span>
</div>

{% endblock %}

{% block extra_js %}
<script>
    // Variables globales
    let selectedDays = new Set();
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();
    let todasSolicitudes = [];
    let filtroActual = 'todas';
    
    const MESES = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                   'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
    const DIAS_SEMANA = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
    
    function showToast(message, type = 'success') {
        const toast = document.getElementById('statusToast');
        toast.className = `status-toast ${type}`;
        document.getElementById('statusIcon').textContent = type === 'success' ? '‚úì' : '‚úó';
        document.getElementById('statusText').textContent = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    function formatDate(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        return `${date.getDate()} ${MESES[date.getMonth()].substring(0, 3)}`;
    }
    
    function formatDateFull(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        return `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
    }
    
    function getDayName(dateStr) {
        const date = new Date(dateStr + 'T00:00:00');
        return DIAS_SEMANA[date.getDay()];
    }
    
    // Renderizar calendario
    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        document.getElementById('calendarMonthYear').textContent = `${MESES[currentMonth]} ${currentYear}`;
        
        // Headers de d√≠as
        let html = DIAS_SEMANA.map(d => `<div class="calendar-day-header">${d}</div>`).join('');
        
        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        // D√≠as vac√≠os al inicio
        for (let i = 0; i < firstDay; i++) {
            html += '<div class="calendar-day empty"></div>';
        }
        
        // D√≠as del mes
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(currentYear, currentMonth, day);
            const dateStr = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const isPast = date < today;
            const isToday = date.getTime() === today.getTime();
            const isSelected = selectedDays.has(dateStr);
            
            let classes = 'calendar-day';
            if (isWeekend) classes += ' weekend';
            if (isPast && !isToday) classes += ' disabled';
            if (isToday) classes += ' today';
            if (isSelected) classes += ' selected';
            
            const clickable = !isWeekend && !isPast;
            
            html += `<div class="${classes}" ${clickable ? `onclick="toggleDay('${dateStr}')"` : ''}>${day}</div>`;
        }
        
        grid.innerHTML = html;
    }
    
    function cambiarMes(delta) {
        currentMonth += delta;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        } else if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar();
    }
    
    function toggleDay(dateStr) {
        if (selectedDays.has(dateStr)) {
            selectedDays.delete(dateStr);
        } else {
            selectedDays.add(dateStr);
        }
        renderCalendar();
        renderSelectedDays();
        updateDaysCount();
    }
    
    function removeDay(dateStr) {
        selectedDays.delete(dateStr);
        renderCalendar();
        renderSelectedDays();
        updateDaysCount();
    }
    
    function limpiarSeleccion() {
        selectedDays.clear();
        renderCalendar();
        renderSelectedDays();
        updateDaysCount();
    }
    
    function renderSelectedDays() {
        const container = document.getElementById('selectedDaysList');
        const clearBtn = document.getElementById('clearAllBtn');
        
        if (selectedDays.size === 0) {
            container.innerHTML = '<div class="no-days-selected">Haz clic en los d√≠as del calendario para seleccionarlos</div>';
            clearBtn.style.display = 'none';
            return;
        }
        
        clearBtn.style.display = 'block';
        
        // Ordenar fechas
        const sortedDays = Array.from(selectedDays).sort();
        
        let html = '';
        sortedDays.forEach(dateStr => {
            html += `
                <div class="selected-day-chip">
                    <span>${getDayName(dateStr)} ${formatDate(dateStr)}</span>
                    <button type="button" class="remove-day" onclick="removeDay('${dateStr}')">‚úï</button>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }
    
    function updateDaysCount() {
        const count = selectedDays.size;
        document.getElementById('diasSolicitados').textContent = count;
        document.getElementById('submitBtn').disabled = count === 0;
    }
    
    async function cargarPerfil() {
        try {
            const response = await fetch('/api/empleados/me');
            if (response.ok) {
                const data = await response.json();
                document.getElementById('diasDisponibles').textContent = data.dias_vacaciones || 0;
            }
        } catch (error) {}
    }
    
    async function cargarSolicitudes() {
        try {
            const response = await fetch('/api/vacaciones/mis-solicitudes');
            if (response.ok) {
                todasSolicitudes = await response.json();
                
                // Calcular estad√≠sticas
                let pendientes = 0, usados = 0;
                todasSolicitudes.forEach(s => {
                    const dias = parseFloat(s.dias_solicitados) || 0;
                    if (s.estatus === 'pendiente') pendientes += dias;
                    if (s.estatus === 'aprobada') usados += dias;
                });
                
                document.getElementById('diasPendientes').textContent = pendientes;
                document.getElementById('diasUsados').textContent = usados;
                
                renderSolicitudes();
            }
        } catch (error) {}
    }
    
    function filtrarSolicitudes(filtro) {
        filtroActual = filtro;
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        renderSolicitudes();
    }
    
    function renderSolicitudes() {
        const container = document.getElementById('solicitudesContainer');
        let filtered = todasSolicitudes;
        
        if (filtroActual !== 'todas') {
            filtered = todasSolicitudes.filter(s => s.estatus === filtroActual);
        }
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üì≠</div>
                    <p>No hay solicitudes para mostrar</p>
                </div>`;
            return;
        }
        
        const TIPOS_SOLICITUD = {
            'usar_dias': 'Usar d√≠as',
            'prima_vacacional': 'Prima vacacional',
            'paternidad': 'Paternidad'
        };
        
        let html = '';
        filtered.forEach(s => {
            const badgeClass = s.estatus === 'pendiente' ? 'pending' : 
                              s.estatus === 'aprobada' ? 'approved' : 'rejected';
            const badgeText = s.estatus.charAt(0).toUpperCase() + s.estatus.slice(1);
            const tipoText = TIPOS_SOLICITUD[s.tipo_solicitud] || 'Usar d√≠as';
            
            // Formatear fechas o mostrar d√≠as espec√≠ficos
            let fechasDisplay = '';
            if (s.dias_especificos && s.dias_especificos.length > 0) {
                fechasDisplay = s.dias_especificos.map(d => formatDateFull(d)).join(', ');
            } else {
                fechasDisplay = `${formatDateFull(s.fecha_inicio)} ‚Üí ${formatDateFull(s.fecha_fin)}`;
            }
            
            html += `
                <div class="request-item">
                    <div class="request-header">
                        <span class="request-dates">${parseFloat(s.dias_solicitados)} d√≠a(s) - ${tipoText}</span>
                        <span class="request-badge ${badgeClass}">${badgeText}</span>
                    </div>
                    <div class="request-days-list">
                        üìÖ ${fechasDisplay}
                    </div>
                    ${s.motivo ? `<div class="request-details" style="margin-top: 8px;"><span>"${s.motivo}"</span></div>` : ''}
                    <div class="request-actions" style="display: flex; gap: 8px; margin-top: 12px;">
                        <button class="btn-download-pdf" onclick="descargarPDF('${s.id}')" style="padding: 6px 12px; border: 1px solid #0093b0; background: white; color: #0093b0; border-radius: 6px; font-size: 12px; cursor: pointer;">
                            üìÑ Descargar PDF
                        </button>
                        ${s.estatus === 'pendiente' ? `
                            <button class="btn-cancel-request" onclick="cancelarSolicitud('${s.id}')">
                                Cancelar solicitud
                            </button>
                        ` : ''}
                    </div>
                    ${s.comentario_admin ? `<p style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);"><strong>Admin:</strong> ${s.comentario_admin}</p>` : ''}
                </div>`;
        });
        
        container.innerHTML = html;
    }
    
    function descargarPDF(id) {
        window.open(`/api/vacaciones/${id}/pdf`, '_blank');
    }
    
    async function cancelarSolicitud(id) {
        if (!confirm('¬øCancelar esta solicitud?')) return;
        try {
            const response = await fetch(`/api/vacaciones/${id}`, { method: 'DELETE' });
            if (response.ok) {
                showToast('Solicitud cancelada', 'success');
                cargarSolicitudes();
            }
        } catch (error) {
            showToast('Error al cancelar', 'error');
        }
    }
    
    // Submit form
    document.getElementById('vacacionesForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (selectedDays.size === 0) {
            showToast('Selecciona al menos un d√≠a', 'error');
            return;
        }
        
        const sortedDays = Array.from(selectedDays).sort();
        const motivo = document.getElementById('motivo').value;
        const tipoSolicitud = document.getElementById('tipoSolicitud').value;
        
        try {
            const response = await fetch('/api/vacaciones/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    fecha_inicio: sortedDays[0],
                    fecha_fin: sortedDays[sortedDays.length - 1],
                    dias_solicitados: sortedDays.length,
                    dias_especificos: sortedDays,
                    tipo_solicitud: tipoSolicitud,
                    motivo: motivo || null
                })
            });
            
            if (response.ok) {
                showToast('Solicitud enviada correctamente', 'success');
                limpiarSeleccion();
                document.getElementById('motivo').value = '';
                document.getElementById('tipoSolicitud').value = 'usar_dias';
                cargarSolicitudes();
                cargarPerfil();
            } else {
                const error = await response.json();
                showToast(error.detail || 'Error al enviar', 'error');
            }
        } catch (error) {
            showToast('Error de conexi√≥n', 'error');
        }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        renderCalendar();
        renderSelectedDays();
        cargarPerfil();
        cargarSolicitudes();
    });
</script>
{% endblock %}
